<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Compuertas L√≥gicas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'led-on': '#00ff00',
                        'led-off': '#333333'
                    }
                }
            }
        }
    </script>
    <style>
        .switch {
            transition: all 0.3s ease;
        }
        .switch.on {
            background-color: #5D5CDE;
            transform: translateX(20px);
        }
        .led {
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        .led.on {
            background-color: #00ff00;
            box-shadow: 0 0 20px #00ff00;
        }
        .gate {
            transition: all 0.2s ease;
        }
        .gate:hover {
            transform: scale(1.05);
        }
        .connection-line {
            stroke: #6b7280;
            stroke-width: 2;
            fill: none;
        }
        .connection-line.active {
            stroke: #5D5CDE;
            stroke-width: 3;
        }
    </style>
</head>
<body class="h-full bg-white dark:bg-gray-900 transition-colors duration-300">
    <div class="min-h-full flex flex-col">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">
                    üîå Simulador de Compuertas L√≥gicas
                </h1>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    Explora las proposiciones y conectores l√≥gicos de forma interactiva
                </p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <!-- Propositions Section -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">
                    üìù Define tus Proposiciones:
                </h2>
                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="proposition-p" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Proposici√≥n P:
                        </label>
                        <input 
                            type="text" 
                            id="proposition-p" 
                            placeholder="Ej: Llueve"
                            class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                            oninput="updatePropositionDisplay()"
                        />
                    </div>
                    <div id="proposition-q-container">
                        <label for="proposition-q" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Proposici√≥n Q:
                        </label>
                        <input 
                            type="text" 
                            id="proposition-q" 
                            placeholder="Ej: Hace fr√≠o"
                            class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                            oninput="updatePropositionDisplay()"
                        />
                    </div>
                    <div id="proposition-r-container">
                        <label for="proposition-r" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Proposici√≥n R:
                        </label>
                        <input 
                            type="text" 
                            id="proposition-r" 
                            placeholder="Ej: Es de noche"
                            class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                            oninput="updatePropositionDisplay()"
                        />
                    </div>
                </div>
            </div>

            <!-- Custom Formula Section -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">
                    üî¨ F√≥rmula Personalizada:
                </h2>
                <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700 mb-4">
                    <div class="mb-3">
                        <label for="custom-formula" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Escribe tu f√≥rmula l√≥gica:
                        </label>
                        <input 
                            type="text" 
                            id="custom-formula" 
                            placeholder="Ej: (p ‚àß q) ‚àß r  o  p ‚Üí (q ‚à® r)"
                            class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-mono"
                            oninput="updateCustomFormula()"
                        />
                    </div>
                    <div class="flex flex-wrap gap-2 mb-3">
                        <span class="text-xs text-gray-600 dark:text-gray-400">S√≠mbolos disponibles:</span>
                        <button onclick="insertSymbol('‚àß')" class="px-2 py-1 text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded hover:bg-blue-200 dark:hover:bg-blue-800">‚àß (y)</button>
                        <button onclick="insertSymbol('‚à®')" class="px-2 py-1 text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded hover:bg-green-200 dark:hover:bg-green-800">‚à® (o)</button>
                        <button onclick="insertSymbol('¬¨')" class="px-2 py-1 text-xs bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded hover:bg-red-200 dark:hover:bg-red-800">¬¨ (no)</button>
                        <button onclick="insertSymbol('‚Üí')" class="px-2 py-1 text-xs bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200 rounded hover:bg-orange-200 dark:hover:bg-orange-800">‚Üí (implica)</button>
                        <button onclick="insertSymbol('‚Üî')" class="px-2 py-1 text-xs bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 rounded hover:bg-purple-200 dark:hover:bg-purple-800">‚Üî (doble)</button>
                        <button onclick="insertSymbol('(')" class="px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-200 dark:hover:bg-gray-600">( )</button>
                    </div>
                    <div id="formula-status" class="text-sm text-gray-600 dark:text-gray-400">
                        Escribe una f√≥rmula para comenzar
                    </div>
                    <div class="mt-3">
                        <span class="text-xs text-gray-600 dark:text-gray-400 mb-2 block">Ejemplos r√°pidos:</span>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="loadExample('(p ‚àß q) ‚à® ¬¨r')" class="px-2 py-1 text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 rounded hover:bg-indigo-200 dark:hover:bg-indigo-800">
                                (p ‚àß q) ‚à® ¬¨r
                            </button>
                            <button onclick="loadExample('p ‚Üí (q ‚à® r)')" class="px-2 py-1 text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded hover:bg-green-200 dark:hover:bg-green-800">
                                p ‚Üí (q ‚à® r)
                            </button>
                            <button onclick="loadExample('(p ‚àß q) ‚Üî ¬¨r')" class="px-2 py-1 text-xs bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 rounded hover:bg-purple-200 dark:hover:bg-purple-800">
                                (p ‚àß q) ‚Üî ¬¨r
                            </button>
                            <button onclick="loadExample('¬¨(p ‚à® q) ‚àß r')" class="px-2 py-1 text-xs bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded hover:bg-red-200 dark:hover:bg-red-800">
                                ¬¨(p ‚à® q) ‚àß r
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gate Selection -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">
                    üîó Selecciona un Conector L√≥gico:
                </h2>
                <div class="flex flex-wrap gap-2">
                    <button onclick="selectGate('CONJUNCION')" class="gate-btn px-4 py-2 bg-primary text-white rounded-lg hover:bg-purple-600 transition-colors">
                        Conjunci√≥n (‚àß)
                    </button>
                    <button onclick="selectGate('DISYUNCION')" class="gate-btn px-4 py-2 bg-primary text-white rounded-lg hover:bg-purple-600 transition-colors">
                        Disyunci√≥n (‚à®)
                    </button>
                    <button onclick="selectGate('NEGACION')" class="gate-btn px-4 py-2 bg-primary text-white rounded-lg hover:bg-purple-600 transition-colors">
                        Negaci√≥n (¬¨)
                    </button>
                    <button onclick="selectGate('IMPLICACION')" class="gate-btn px-4 py-2 bg-primary text-white rounded-lg hover:bg-purple-600 transition-colors">
                        Implicaci√≥n (‚Üí)
                    </button>
                    <button onclick="selectGate('DOBLE_IMPLICACION')" class="gate-btn px-4 py-2 bg-primary text-white rounded-lg hover:bg-purple-600 transition-colors">
                        Doble Implicaci√≥n (‚Üî)
                    </button>
                </div>
            </div>

            <!-- Circuit Area -->
            <div class="grid lg:grid-cols-2 gap-6">
                <!-- Visual Circuit -->
                <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                        Circuito Visual
                    </h3>
                    
                    <!-- Input Controls -->
                    <div class="mb-6">
                        <div class="flex flex-col space-y-4">
                            <div id="input-a-container" class="flex items-center justify-between">
                                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Entrada A (Proposici√≥n P):
                                </label>
                                <div class="flex items-center space-x-3">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">OFF</span>
                                    <div class="relative w-12 h-6 bg-gray-300 dark:bg-gray-600 rounded-full cursor-pointer" onclick="toggleInput('A')">
                                        <div id="switch-a" class="switch absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full"></div>
                                    </div>
                                    <span class="text-sm text-gray-600 dark:text-gray-400">ON</span>
                                </div>
                            </div>
                            
                            <div id="input-b-container" class="flex items-center justify-between">
                                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Entrada B (Proposici√≥n Q):
                                </label>
                                <div class="flex items-center space-x-3">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">OFF</span>
                                    <div class="relative w-12 h-6 bg-gray-300 dark:bg-gray-600 rounded-full cursor-pointer" onclick="toggleInput('B')">
                                        <div id="switch-b" class="switch absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full"></div>
                                    </div>
                                    <span class="text-sm text-gray-600 dark:text-gray-400">ON</span>
                                </div>
                            </div>
                            
                            <div id="input-r-container" class="flex items-center justify-between" style="display: none;">
                                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Entrada R (Proposici√≥n R):
                                </label>
                                <div class="flex items-center space-x-3">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">OFF</span>
                                    <div class="relative w-12 h-6 bg-gray-300 dark:bg-gray-600 rounded-full cursor-pointer" onclick="toggleInput('R')">
                                        <div id="switch-r" class="switch absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full"></div>
                                    </div>
                                    <span class="text-sm text-gray-600 dark:text-gray-400">ON</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Circuit Diagram -->
                    <div class="relative bg-white dark:bg-gray-700 rounded-lg p-6 border-2 border-gray-200 dark:border-gray-600">
                        <svg id="circuit-svg" width="100%" height="200" viewBox="0 0 400 200" class="overflow-visible">
                            <!-- Input A line -->
                            <line id="line-a" x1="20" y1="60" x2="120" y2="60" class="connection-line" />
                            <!-- Input B line -->
                            <line id="line-b" x1="20" y1="140" x2="120" y2="140" class="connection-line" />
                            <!-- Gate symbol -->
                            <g id="gate-symbol" transform="translate(120, 100)">
                                <!-- Will be populated by JavaScript -->
                            </g>
                            <!-- Output line -->
                            <line id="line-output" x1="220" y1="100" x2="320" y2="100" class="connection-line" />
                        </svg>
                        
                        <!-- Input labels -->
                        <div class="absolute left-2 top-12 text-xs font-medium text-gray-600 dark:text-gray-400">A</div>
                        <div class="absolute left-2 top-32 text-xs font-medium text-gray-600 dark:text-gray-400">B</div>
                        
                        <!-- LED Output -->
                        <div class="absolute right-8 top-20">
                            <div id="led" class="led w-12 h-12 rounded-full bg-gray-400 dark:bg-gray-600 border-2 border-gray-300 dark:border-gray-500"></div>
                            <div class="text-xs text-center mt-1 text-gray-600 dark:text-gray-400">LED</div>
                        </div>
                    </div>
                </div>

                <!-- Logic Information -->
                <div class="space-y-4">
                    <!-- Truth Table -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                            Tabla de Verdad
                        </h3>
                        <div class="overflow-x-auto">
                            <table id="truth-table" class="w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-200 dark:border-gray-600">
                                        <th class="text-left py-2 px-3 text-gray-700 dark:text-gray-300">P</th>
                                        <th class="text-left py-2 px-3 text-gray-700 dark:text-gray-300">Q</th>
                                        <th class="text-left py-2 px-3 text-gray-700 dark:text-gray-300">Resultado</th>
                                    </tr>
                                </thead>
                                <tbody id="truth-table-body">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Logic Explanation -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                            Explicaci√≥n L√≥gica
                        </h3>
                        <div id="logic-explanation" class="text-sm text-gray-700 dark:text-gray-300">
                            Selecciona una compuerta para ver su explicaci√≥n.
                        </div>
                    </div>

                    <!-- Current State -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                            Estado Actual
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Proposici√≥n P (A):</span>
                                <span id="state-a" class="font-medium text-gray-900 dark:text-white">FALSO</span>
                            </div>
                            <div id="state-b-container" class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Proposici√≥n Q (B):</span>
                                <span id="state-b" class="font-medium text-gray-900 dark:text-white">FALSO</span>
                            </div>
                            <div class="flex justify-between border-t border-gray-200 dark:border-gray-600 pt-2">
                                <span class="text-gray-600 dark:text-gray-400">Resultado:</span>
                                <span id="state-result" class="font-bold text-primary">FALSO</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Circuit state
        let currentGate = 'CONJUNCION';
        let inputA = false;
        let inputB = false;
        let inputR = false;
        let customFormulaMode = false;
        let currentFormula = '';

        // Gate definitions (Conectores L√≥gicos)
        const gates = {
            'CONJUNCION': {
                name: 'Conjunci√≥n (‚àß)',
                symbol: `<rect x="-40" y="-30" width="80" height="60" rx="15" fill="#4f46e5" stroke="#1e1b4b" stroke-width="2"/>
                        <text x="0" y="-5" text-anchor="middle" fill="white" font-size="14" font-weight="bold">‚àß</text>
                        <text x="0" y="15" text-anchor="middle" fill="white" font-size="8">AND</text>`,
                inputs: 2,
                logic: (a, b) => a && b,
                explanation: `
                    <p class="mb-2"><strong>Conjunci√≥n (‚àß):</strong></p>
                    <p class="mb-2">Es verdadera SOLO cuando AMBAS proposiciones son verdaderas.</p>
                    <p class="mb-2"><strong>F√≥rmula:</strong> P ‚àß Q</p>
                    <p class="mb-2"><strong>Ejemplo:</strong> Si P = "Llueve" y Q = "Hace fr√≠o"</p>
                    <p><strong>Resultado:</strong> "Llueve Y hace fr√≠o" - Ambas condiciones deben cumplirse.</p>
                `,
                truthTable: [
                    [false, false, false],
                    [false, true, false],
                    [true, false, false],
                    [true, true, true]
                ]
            },
            'DISYUNCION': {
                name: 'Disyunci√≥n (‚à®)',
                symbol: `<path d="M -40,-30 Q 0,-30 40,-15 Q 40,15 40,15 Q 0,30 -40,30 Q -20,0 -40,-30" fill="#059669" stroke="#064e3b" stroke-width="2"/>
                        <text x="0" y="-5" text-anchor="middle" fill="white" font-size="14" font-weight="bold">‚à®</text>
                        <text x="0" y="15" text-anchor="middle" fill="white" font-size="8">OR</text>`,
                inputs: 2,
                logic: (a, b) => a || b,
                explanation: `
                    <p class="mb-2"><strong>Disyunci√≥n (‚à®):</strong></p>
                    <p class="mb-2">Es verdadera cuando AL MENOS UNA proposici√≥n es verdadera.</p>
                    <p class="mb-2"><strong>F√≥rmula:</strong> P ‚à® Q</p>
                    <p class="mb-2"><strong>Ejemplo:</strong> Si P = "Llueve" y Q = "Hace fr√≠o"</p>
                    <p><strong>Resultado:</strong> "Llueve O hace fr√≠o" - Al menos una condici√≥n debe cumplirse.</p>
                `,
                truthTable: [
                    [false, false, false],
                    [false, true, true],
                    [true, false, true],
                    [true, true, true]
                ]
            },
            'NEGACION': {
                name: 'Negaci√≥n (¬¨)',
                symbol: `<polygon points="-30,-20 30,0 -30,20" fill="#dc2626" stroke="#7f1d1d" stroke-width="2"/>
                        <circle cx="35" cy="0" r="5" fill="none" stroke="#7f1d1d" stroke-width="2"/>
                        <text x="-5" y="5" text-anchor="middle" fill="white" font-size="12" font-weight="bold">¬¨</text>`,
                inputs: 1,
                logic: (a) => !a,
                explanation: `
                    <p class="mb-2"><strong>Negaci√≥n (¬¨):</strong></p>
                    <p class="mb-2">Cambia el valor de verdad de la proposici√≥n al OPUESTO.</p>
                    <p class="mb-2"><strong>F√≥rmula:</strong> ¬¨P</p>
                    <p class="mb-2"><strong>Ejemplo:</strong> Si P = "Llueve"</p>
                    <p><strong>Resultado:</strong> "NO llueve" - Lo contrario de la proposici√≥n original.</p>
                `,
                truthTable: [
                    [false, true],
                    [true, false]
                ]
            },
            'IMPLICACION': {
                name: 'Implicaci√≥n (‚Üí)',
                symbol: `<polygon points="-40,-30 20,-30 40,-10 40,10 20,30 -40,30 -20,0" fill="#7c2d12" stroke="#431407" stroke-width="2"/>
                        <text x="-5" y="-5" text-anchor="middle" fill="white" font-size="14" font-weight="bold">‚Üí</text>
                        <text x="-5" y="15" text-anchor="middle" fill="white" font-size="8">IMPL</text>`,
                inputs: 2,
                logic: (a, b) => !a || b,
                explanation: `
                    <p class="mb-2"><strong>Implicaci√≥n (‚Üí):</strong></p>
                    <p class="mb-2">Es falsa SOLO cuando la primera proposici√≥n es verdadera y la segunda es falsa.</p>
                    <p class="mb-2"><strong>F√≥rmula:</strong> P ‚Üí Q</p>
                    <p class="mb-2"><strong>Ejemplo:</strong> Si P = "Llueve" y Q = "Hace fr√≠o"</p>
                    <p><strong>Resultado:</strong> "Si llueve, entonces hace fr√≠o" - La lluvia implica fr√≠o.</p>
                `,
                truthTable: [
                    [false, false, true],
                    [false, true, true],
                    [true, false, false],
                    [true, true, true]
                ]
            },
            'DOBLE_IMPLICACION': {
                name: 'Doble Implicaci√≥n (‚Üî)',
                symbol: `<ellipse cx="0" cy="0" rx="40" ry="25" fill="#9333ea" stroke="#581c87" stroke-width="2"/>
                        <text x="0" y="-5" text-anchor="middle" fill="white" font-size="14" font-weight="bold">‚Üî</text>
                        <text x="0" y="15" text-anchor="middle" fill="white" font-size="8">BIIM</text>`,
                inputs: 2,
                logic: (a, b) => (a && b) || (!a && !b),
                explanation: `
                    <p class="mb-2"><strong>Doble Implicaci√≥n (‚Üî):</strong></p>
                    <p class="mb-2">Es verdadera cuando AMBAS proposiciones tienen EL MISMO valor de verdad.</p>
                    <p class="mb-2"><strong>F√≥rmula:</strong> P ‚Üî Q</p>
                    <p class="mb-2"><strong>Ejemplo:</strong> Si P = "Llueve" y Q = "Hace fr√≠o"</p>
                    <p><strong>Resultado:</strong> "Llueve si y solo si hace fr√≠o" - Ambas ocurren juntas o no ocurren.</p>
                `,
                truthTable: [
                    [false, false, true],
                    [false, true, false],
                    [true, false, false],
                    [true, true, true]
                ]
            }
        };

        function selectGate(gateName) {
            currentGate = gateName;
            updateGateSymbol();
            updateTruthTable();
            updateLogicExplanation();
            updateInputVisibility();
            updatePropositionInputVisibility();
            updatePropositionDisplay();
            updateCircuit();
            
            // Update button styles
            document.querySelectorAll('.gate-btn').forEach(btn => {
                btn.classList.remove('bg-purple-700');
                btn.classList.add('bg-primary');
            });
            event.target.classList.remove('bg-primary');
            event.target.classList.add('bg-purple-700');
        }

        function updateGateSymbol() {
            const gateSymbol = document.getElementById('gate-symbol');
            gateSymbol.innerHTML = gates[currentGate].symbol;
        }

        function updateInputVisibility() {
            const inputBContainer = document.getElementById('input-b-container');
            const stateBContainer = document.getElementById('state-b-container');
            const lineB = document.getElementById('line-b');
            
            if (gates[currentGate].inputs === 1) {
                inputBContainer.style.display = 'none';
                stateBContainer.style.display = 'none';
                lineB.style.display = 'none';
                
                // Adjust input A line for NOT gate
                document.getElementById('line-a').setAttribute('y1', '100');
                document.getElementById('line-a').setAttribute('y2', '100');
            } else {
                inputBContainer.style.display = 'flex';
                stateBContainer.style.display = 'flex';
                lineB.style.display = 'block';
                
                // Reset input A line position
                document.getElementById('line-a').setAttribute('y1', '60');
                document.getElementById('line-a').setAttribute('y2', '60');
            }
        }

        function updateTruthTable() {
            const tbody = document.getElementById('truth-table-body');
            const gate = gates[currentGate];
            
            let tableHTML = '';
            if (gate.inputs === 1) {
                // Hide Q column for NOT gate
                document.querySelector('#truth-table th:nth-child(2)').style.display = 'none';
                gate.truthTable.forEach(row => {
                    const isCurrentRow = row[0] === inputA;
                    tableHTML += `
                        <tr class="${isCurrentRow ? 'bg-yellow-100 dark:bg-yellow-900' : ''}">
                            <td class="py-2 px-3 ${row[0] ? 'text-green-600 font-medium' : 'text-red-600 font-medium'}">${row[0] ? 'V' : 'F'}</td>
                            <td class="py-2 px-3" style="display: none;"></td>
                            <td class="py-2 px-3 ${row[1] ? 'text-green-600 font-bold' : 'text-red-600 font-bold'}">${row[1] ? 'V' : 'F'}</td>
                        </tr>
                    `;
                });
            } else {
                // Show Q column for two-input gates
                document.querySelector('#truth-table th:nth-child(2)').style.display = 'table-cell';
                gate.truthTable.forEach(row => {
                    const isCurrentRow = row[0] === inputA && row[1] === inputB;
                    tableHTML += `
                        <tr class="${isCurrentRow ? 'bg-yellow-100 dark:bg-yellow-900' : ''}">
                            <td class="py-2 px-3 ${row[0] ? 'text-green-600 font-medium' : 'text-red-600 font-medium'}">${row[0] ? 'V' : 'F'}</td>
                            <td class="py-2 px-3 ${row[1] ? 'text-green-600 font-medium' : 'text-red-600 font-medium'}">${row[1] ? 'V' : 'F'}</td>
                            <td class="py-2 px-3 ${row[2] ? 'text-green-600 font-bold' : 'text-red-600 font-bold'}">${row[2] ? 'V' : 'F'}</td>
                        </tr>
                    `;
                });
            }
            
            tbody.innerHTML = tableHTML;
        }

        function updateLogicExplanation() {
            const explanation = document.getElementById('logic-explanation');
            explanation.innerHTML = gates[currentGate].explanation;
        }

        function toggleInput(input) {
            if (input === 'A') {
                inputA = !inputA;
                const switchA = document.getElementById('switch-a');
                switchA.classList.toggle('on', inputA);
            } else if (input === 'B') {
                inputB = !inputB;
                const switchB = document.getElementById('switch-b');
                switchB.classList.toggle('on', inputB);
            } else if (input === 'R') {
                inputR = !inputR;
                const switchR = document.getElementById('switch-r');
                switchR.classList.toggle('on', inputR);
            }
            
            if (customFormulaMode) {
                updateCustomCircuit();
                updateCustomTruthTable();
            } else {
                updateCircuit();
                updateTruthTable();
            }
        }

        function updateCircuit() {
            // Calculate result
            const gate = gates[currentGate];
            let result;
            if (gate.inputs === 1) {
                result = gate.logic(inputA);
            } else {
                result = gate.logic(inputA, inputB);
            }
            
            // Update LED
            const led = document.getElementById('led');
            led.classList.toggle('on', result);
            
            // Update connection lines
            const lineA = document.getElementById('line-a');
            const lineB = document.getElementById('line-b');
            const lineOutput = document.getElementById('line-output');
            
            lineA.classList.toggle('active', inputA);
            if (gate.inputs === 2) {
                lineB.classList.toggle('active', inputB);
            }
            lineOutput.classList.toggle('active', result);
            
            // Update state display
            document.getElementById('state-a').textContent = inputA ? 'VERDADERO' : 'FALSO';
            document.getElementById('state-a').className = `font-medium ${inputA ? 'text-green-600' : 'text-red-600'}`;
            
            if (gate.inputs === 2) {
                document.getElementById('state-b').textContent = inputB ? 'VERDADERO' : 'FALSO';
                document.getElementById('state-b').className = `font-medium ${inputB ? 'text-green-600' : 'text-red-600'}`;
            }
            
            document.getElementById('state-result').textContent = result ? 'VERDADERO' : 'FALSO';
            document.getElementById('state-result').className = `font-bold ${result ? 'text-green-600' : 'text-red-600'}`;
        }

        function updatePropositionDisplay() {
            const propP = document.getElementById('proposition-p').value || 'P';
            const propQ = document.getElementById('proposition-q').value || 'Q';
            
            // Update input labels
            const labelA = document.querySelector('#input-a-container label');
            const labelB = document.querySelector('#input-b-container label');
            
            labelA.textContent = `Entrada A (${propP}):`;
            if (gates[currentGate].inputs === 2) {
                labelB.textContent = `Entrada B (${propQ}):`;
            }
            
            // Update state display
            const stateALabel = document.querySelector('#state-a').previousElementSibling;
            const stateBLabel = document.querySelector('#state-b').previousElementSibling;
            
            stateALabel.textContent = `${propP}:`;
            if (gates[currentGate].inputs === 2) {
                stateBLabel.textContent = `${propQ}:`;
            }
            
            // Update explanation with current propositions
            updateLogicExplanationWithProps();
        }

        function updateLogicExplanationWithProps() {
            const propP = document.getElementById('proposition-p').value || 'P';
            const propQ = document.getElementById('proposition-q').value || 'Q';
            const explanation = document.getElementById('logic-explanation');
            const gate = gates[currentGate];
            
            let customExplanation = gate.explanation;
            
            // Replace examples with user's propositions if they exist
            if (propP !== 'P' && propP.trim() !== '') {
                customExplanation = customExplanation.replace(/"Llueve"/g, `"${propP}"`);
                customExplanation = customExplanation.replace(/Llueve/g, propP);
            }
            
            if (propQ !== 'Q' && propQ.trim() !== '' && gate.inputs === 2) {
                customExplanation = customExplanation.replace(/"Hace fr√≠o"/g, `"${propQ}"`);
                customExplanation = customExplanation.replace(/hace fr√≠o/g, propQ.toLowerCase());
                customExplanation = customExplanation.replace(/fr√≠o/g, propQ.toLowerCase());
            }
            
            explanation.innerHTML = customExplanation;
        }

        function updatePropositionInputVisibility() {
            const propQContainer = document.getElementById('proposition-q-container');
            
            if (gates[currentGate].inputs === 1) {
                propQContainer.style.display = 'none';
            } else {
                propQContainer.style.display = 'block';
            }
        }

        // Custom formula functions
        function insertSymbol(symbol) {
            const formulaInput = document.getElementById('custom-formula');
            const start = formulaInput.selectionStart;
            const end = formulaInput.selectionEnd;
            const text = formulaInput.value;
            
            let insertion = symbol;
            if (symbol === '(') {
                insertion = '()';
            }
            
            formulaInput.value = text.substring(0, start) + insertion + text.substring(end);
            formulaInput.focus();
            
            // Position cursor
            const cursorPos = start + (symbol === '(' ? 1 : insertion.length);
            formulaInput.setSelectionRange(cursorPos, cursorPos);
            
            updateCustomFormula();
        }

        function updateCustomFormula() {
            const formula = document.getElementById('custom-formula').value.trim();
            const status = document.getElementById('formula-status');
            
            if (formula === '') {
                customFormulaMode = false;
                status.textContent = 'Escribe una f√≥rmula para comenzar';
                status.className = 'text-sm text-gray-600 dark:text-gray-400';
                updateTruthTable();
                return;
            }
            
            try {
                currentFormula = formula;
                customFormulaMode = true;
                
                // Test the formula with sample values
                const testResult = evaluateFormula(formula, true, true, true);
                status.innerHTML = `‚úÖ <span class="font-mono">${formula}</span> - F√≥rmula v√°lida`;
                status.className = 'text-sm text-green-600 dark:text-green-400';
                
                // Switch to custom mode and update everything
                updateCustomFormulaInterface();
                
            } catch (error) {
                status.innerHTML = `‚ùå Error: ${error.message}`;
                status.className = 'text-sm text-red-600 dark:text-red-400';
                customFormulaMode = false;
            }
        }

        function evaluateFormula(formula, p, q, r) {
            // Simple recursive evaluator for logical formulas
            function evaluateExpression(expr, values) {
                // Remove all spaces
                expr = expr.replace(/\s+/g, '');
                
                // Base cases - single variables or negated variables
                if (expr === 'p') return values.p;
                if (expr === 'q') return values.q;
                if (expr === 'r') return values.r;
                if (expr === '¬¨p') return !values.p;
                if (expr === '¬¨q') return !values.q;
                if (expr === '¬¨r') return !values.r;
                if (expr === 'true') return true;
                if (expr === 'false') return false;
                
                // Handle parentheses - find the main operator outside parentheses
                let parenLevel = 0;
                let mainOpIndex = -1;
                let mainOp = '';
                
                // Look for main operator (rightmost to respect precedence)
                for (let i = expr.length - 1; i >= 0; i--) {
                    if (expr[i] === ')') parenLevel++;
                    else if (expr[i] === '(') parenLevel--;
                    else if (parenLevel === 0) {
                        // Check for operators (‚Üî has lowest precedence)
                        if (expr[i] === '‚Üî') {
                            mainOpIndex = i;
                            mainOp = '‚Üî';
                            break;
                        }
                        else if (expr[i] === '‚Üí') {
                            mainOpIndex = i;
                            mainOp = '‚Üí';
                            break;
                        }
                        else if (expr[i] === '‚à®') {
                            mainOpIndex = i;
                            mainOp = '‚à®';
                            // Don't break - keep looking for lower precedence ops
                        }
                        else if (expr[i] === '‚àß' && mainOp !== '‚à®') {
                            mainOpIndex = i;
                            mainOp = '‚àß';
                        }
                    }
                }
                
                // Handle negation at the start
                if (mainOpIndex === -1 && expr[0] === '¬¨') {
                    return !evaluateExpression(expr.substring(1), values);
                }
                
                // Handle parentheses around the whole expression
                if (mainOpIndex === -1 && expr[0] === '(' && expr[expr.length-1] === ')') {
                    return evaluateExpression(expr.substring(1, expr.length-1), values);
                }
                
                // Apply the main operator
                if (mainOpIndex !== -1) {
                    const left = expr.substring(0, mainOpIndex);
                    const right = expr.substring(mainOpIndex + (mainOp === '‚Üî' ? 2 : 1));
                    
                    const leftVal = evaluateExpression(left, values);
                    const rightVal = evaluateExpression(right, values);
                    
                    switch (mainOp) {
                        case '‚àß': return leftVal && rightVal;
                        case '‚à®': return leftVal || rightVal;
                        case '‚Üí': return !leftVal || rightVal;
                        case '‚Üî': return (leftVal && rightVal) || (!leftVal && !rightVal);
                    }
                }
                
                throw new Error(`No se puede evaluar la expresi√≥n: ${expr}`);
            }
            
            try {
                return evaluateExpression(formula, { p: p, q: q, r: r });
            } catch (error) {
                throw new Error(`Error en la f√≥rmula "${formula}": ${error.message}`);
            }
        }

        function updateCustomFormulaInterface() {
            if (!customFormulaMode) return;
            
            // Show third input
            document.getElementById('input-r-container').style.display = 'flex';
            
            // Add R to state display if not present
            const stateContainer = document.querySelector('#state-b-container').parentNode;
            let stateRContainer = document.getElementById('state-r-container');
            
            if (!stateRContainer) {
                stateRContainer = document.createElement('div');
                stateRContainer.id = 'state-r-container';
                stateRContainer.className = 'flex justify-between';
                stateRContainer.innerHTML = `
                    <span class="text-gray-600 dark:text-gray-400">Proposici√≥n R:</span>
                    <span id="state-r" class="font-medium text-gray-900 dark:text-white">FALSO</span>
                `;
                stateContainer.insertBefore(stateRContainer, stateContainer.lastElementChild);
            }
            
            updatePropositionDisplayCustom();
            updateCustomTruthTable();
            updateCustomCircuit();
            updateCustomExplanation();
        }

        function updatePropositionDisplayCustom() {
            const propP = document.getElementById('proposition-p').value || 'P';
            const propQ = document.getElementById('proposition-q').value || 'Q';
            const propR = document.getElementById('proposition-r').value || 'R';
            
            document.querySelector('#input-a-container label').textContent = `Entrada A (${propP}):`;
            document.querySelector('#input-b-container label').textContent = `Entrada B (${propQ}):`;
            document.querySelector('#input-r-container label').textContent = `Entrada R (${propR}):`;
            
            document.querySelector('#state-a').previousElementSibling.textContent = `${propP}:`;
            document.querySelector('#state-b').previousElementSibling.textContent = `${propQ}:`;
            document.querySelector('#state-r').previousElementSibling.textContent = `${propR}:`;
        }

        function updateCustomTruthTable() {
            const tbody = document.getElementById('truth-table-body');
            const table = document.getElementById('truth-table');
            
            // Update table header for 3 propositions
            const thead = table.querySelector('thead tr');
            thead.innerHTML = `
                <th class="text-left py-2 px-3 text-gray-700 dark:text-gray-300">P</th>
                <th class="text-left py-2 px-3 text-gray-700 dark:text-gray-300">Q</th>
                <th class="text-left py-2 px-3 text-gray-700 dark:text-gray-300">R</th>
                <th class="text-left py-2 px-3 text-gray-700 dark:text-gray-300">${currentFormula}</th>
            `;
            
            // Generate all 8 combinations (2^3)
            let tableHTML = '';
            for (let i = 0; i < 8; i++) {
                const p = !!(i & 4);
                const q = !!(i & 2);
                const r = !!(i & 1);
                
                try {
                    const result = evaluateFormula(currentFormula, p, q, r);
                    const isCurrentRow = p === inputA && q === inputB && r === inputR;
                    
                    tableHTML += `
                        <tr class="${isCurrentRow ? 'bg-yellow-100 dark:bg-yellow-900' : ''}">
                            <td class="py-2 px-3 ${p ? 'text-green-600 font-medium' : 'text-red-600 font-medium'}">${p ? 'V' : 'F'}</td>
                            <td class="py-2 px-3 ${q ? 'text-green-600 font-medium' : 'text-red-600 font-medium'}">${q ? 'V' : 'F'}</td>
                            <td class="py-2 px-3 ${r ? 'text-green-600 font-medium' : 'text-red-600 font-medium'}">${r ? 'V' : 'F'}</td>
                            <td class="py-2 px-3 ${result ? 'text-green-600 font-bold' : 'text-red-600 font-bold'}">${result ? 'V' : 'F'}</td>
                        </tr>
                    `;
                } catch (error) {
                    tableHTML += `
                        <tr>
                            <td class="py-2 px-3">${p ? 'V' : 'F'}</td>
                            <td class="py-2 px-3">${q ? 'V' : 'F'}</td>
                            <td class="py-2 px-3">${r ? 'V' : 'F'}</td>
                            <td class="py-2 px-3 text-red-600">Error</td>
                        </tr>
                    `;
                }
            }
            
            tbody.innerHTML = tableHTML;
        }

        function updateCustomCircuit() {
            try {
                const result = evaluateFormula(currentFormula, inputA, inputB, inputR);
                
                // Update LED
                document.getElementById('led').classList.toggle('on', result);
                
                // Update lines
                document.getElementById('line-a').classList.toggle('active', inputA);
                document.getElementById('line-b').classList.toggle('active', inputB);
                document.getElementById('line-output').classList.toggle('active', result);
                
                // Update state display
                document.getElementById('state-a').textContent = inputA ? 'VERDADERO' : 'FALSO';
                document.getElementById('state-a').className = `font-medium ${inputA ? 'text-green-600' : 'text-red-600'}`;
                
                document.getElementById('state-b').textContent = inputB ? 'VERDADERO' : 'FALSO';
                document.getElementById('state-b').className = `font-medium ${inputB ? 'text-green-600' : 'text-red-600'}`;
                
                document.getElementById('state-r').textContent = inputR ? 'VERDADERO' : 'FALSO';
                document.getElementById('state-r').className = `font-medium ${inputR ? 'text-green-600' : 'text-red-600'}`;
                
                document.getElementById('state-result').textContent = result ? 'VERDADERO' : 'FALSO';
                document.getElementById('state-result').className = `font-bold ${result ? 'text-green-600' : 'text-red-600'}`;
                
                // Update gate symbol
                const gateSymbol = document.getElementById('gate-symbol');
                gateSymbol.innerHTML = `
                    <rect x="-50" y="-35" width="100" height="70" rx="10" fill="#6366f1" stroke="#4338ca" stroke-width="2"/>
                    <text x="0" y="-10" text-anchor="middle" fill="white" font-size="10" font-weight="bold">${currentFormula}</text>
                    <text x="0" y="10" text-anchor="middle" fill="white" font-size="8">CUSTOM</text>
                `;
                
            } catch (error) {
                console.error('Error evaluating formula:', error);
            }
        }

        function updateCustomExplanation() {
            const explanation = document.getElementById('logic-explanation');
            const propP = document.getElementById('proposition-p').value || 'P';
            const propQ = document.getElementById('proposition-q').value || 'Q';
            const propR = document.getElementById('proposition-r').value || 'R';
            
            try {
                const currentResult = evaluateFormula(currentFormula, inputA, inputB, inputR);
                explanation.innerHTML = `
                    <p class="mb-2"><strong>F√≥rmula Personalizada:</strong></p>
                    <p class="mb-2 font-mono text-lg">${currentFormula}</p>
                    <p class="mb-2"><strong>Proposiciones:</strong></p>
                    <ul class="list-disc list-inside text-sm space-y-1 mb-2">
                        <li>P = "${propP}"</li>
                        <li>Q = "${propQ}"</li>
                        <li>R = "${propR}"</li>
                    </ul>
                    <p class="mb-2"><strong>Evaluaci√≥n actual:</strong></p>
                    <p class="text-sm">Con P=${inputA ? 'V' : 'F'}, Q=${inputB ? 'V' : 'F'}, R=${inputR ? 'V' : 'F'}: 
                       <span class="font-bold ${currentResult ? 'text-green-600' : 'text-red-600'}">
                           ${currentResult ? 'VERDADERO' : 'FALSO'}
                       </span>
                    </p>
                `;
            } catch (error) {
                explanation.innerHTML = `
                    <p class="mb-2"><strong>Error en la f√≥rmula:</strong></p>
                    <p class="text-red-600">${error.message}</p>
                `;
            }
        }

        // Override the original updateTruthTable for custom mode
        const originalUpdateTruthTable = updateTruthTable;
        updateTruthTable = function() {
            if (customFormulaMode) {
                updateCustomTruthTable();
            } else {
                originalUpdateTruthTable();
            }
        };

        // Load example formulas
        function loadExample(formula) {
            document.getElementById('custom-formula').value = formula;
            updateCustomFormula();
        }

        // Initialize with CONJUNCION gate
        selectGate('CONJUNCION');
        updatePropositionDisplay();
    </script>
</body>
</html>